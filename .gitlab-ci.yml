   
stages:
  - build
  - deploy
  

cache:
  paths:
    - node_modules/
    
variables:
  APP_NAME: medplatformapp

build:
  stage: build
  image: node:latest
  script:
    - npm install --progress=false
    - npm run build

deploy:
    image: docker:latest
    services:
        - docker:dind
    stage: deploy
    script:
        - docker login -u $CI_DEPLOY_USER -p $CI_DEPLOY_PASSWORD $CI_REGISTRY
        - docker pull $CI_REGISTRY_IMAGE:latest
        - docker tag $CI_REGISTRY_IMAGE:latest $HEROKU_REGISTRY_IMAGE:latest
        - docker login --username=_ --password=$HEROKU_API_KEY $HEROKU_REGISTRY
        - docker push $HEROKU_REGISTRY_IMAGE:latest
        - docker run --rm -e HEROKU_API_KEY=$HEROKU_API_KEY wingrunr21/alpine-heroku-cli container:release web --app $APP_NAME